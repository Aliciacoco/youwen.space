<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>由闻之境 — 个人站点</title>
  <meta name="description" content="由闻之境 · 极简作品集与博客。" />
  <meta property="og:title" content="由闻之境 — 个人站点" />
  <meta property="og:description" content="极简作品集与博客（瀑布流 + 弹窗文章）。" />
  <meta property="og:type" content="website" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='46' fill='%232C6E49'/%3E%3Ctext x='50' y='60' font-size='52' text-anchor='middle' fill='white' font-family='serif'%3E由%3C/text%3E%3C/svg%3E"/>
  <style>
    :root{
      --bg: #ffffff; --text: #1e1e1e; --muted: #6b7280;
      --brand: #2c6e49; --accent: #ffc857; --card: #f6f6f6;
      --radius: 16px; --shadow: 0 6px 24px rgba(0,0,0,.06); --maxw: 1120px;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0b0c0d; --text:#f4f4f5; --muted:#a1a1aa; --card:#111315; --shadow:0 6px 24px rgba(0,0,0,.5); }
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.7 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,"Noto Sans CJK SC",sans-serif}
    img,video{max-width:100%;height:auto;display:block;border-radius:12px} a{color:inherit;text-decoration:none}
    .container{max-width:var(--maxw);margin:0 auto;padding:24px}
    header{position:sticky;top:0;background:linear-gradient(to bottom,var(--bg) 70%,transparent);backdrop-filter:saturate(120%) blur(6px);z-index:10}
    .brand{display:flex;align-items:center;gap:12px;padding:12px 24px}
    .brand .logo{width:36px;height:36px;border-radius:10px;background:var(--brand);display:grid;place-items:center;color:white;font-weight:700}
    .brand .title{font-size:18px;font-weight:700;letter-spacing:.5px}
    .hero{padding:32px 24px 8px}
    .hero h1{font-size:clamp(24px,4vw,36px);margin:0 0 8px 0;line-height:1.25}
    .hero p{margin:0;color:var(--muted)}
    .filters{display:flex;flex-wrap:wrap;gap:8px;margin:20px 24px}
    .chip{padding:8px 12px;border:1px solid color-mix(in oklab, var(--text) 20%, transparent);border-radius:999px;cursor:pointer;user-select:none}
    .chip[aria-pressed="true"]{background:var(--brand);border-color:var(--brand);color:white}
    .masonry{column-gap:16px;padding:8px 24px 80px}
    @media (min-width: 640px){ .masonry{ column-count: 2; } }
    @media (min-width: 960px){ .masonry{ column-count: 3; } }
    .card{break-inside:avoid;background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);margin:0 0 16px 0;display:block;overflow:hidden;transition:transform .15s ease}
    .card:hover{transform:translateY(-2px)}
    .card .cover{aspect-ratio: 16/10;object-fit:cover}
    .card .content{padding:12px 14px 14px}
    .card .title{font-weight:700;margin:6px 0 6px}
    .badge{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:color-mix(in oklab,var(--brand) 12%, transparent);color:var(--brand);margin-right:6px;margin-bottom:6px}
    .modal{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;background:rgba(0,0,0,.4);padding:24px;z-index:50}
    .modal[open]{display:flex}
    .dialog{position:relative;max-width:880px;width:min(92vw,880px);max-height:92vh;overflow:auto;background:var(--bg);border-radius:20px;box-shadow:var(--shadow);padding:20px}
    .modal header{position:sticky;top:0;background:var(--bg);padding:8px 0 12px;margin-bottom:6px;border-bottom:1px solid color-mix(in oklab, var(--text) 10%, transparent)}
    .dialog .h1{font-size:clamp(22px,3.4vw,30px);margin:0 0 6px 0}
    .meta{color:var(--muted);font-size:14px}
    .article{display:grid;gap:16px}
    .close{position:absolute;top:10px;right:10px;border:none;background:transparent;width:40px;height:40px;border-radius:10px;cursor:pointer}
    .close:after{content:"✕";font-size:20px}
    .figure{display:grid;gap:8px} .figure figcaption{font-size:14px;color:var(--muted)}
    .to-top{position:fixed;right:16px;bottom:16px;background:var(--brand);color:#fff;border:none;border-radius:999px;padding:10px 14px;box-shadow:var(--shadow);cursor:pointer}
    #addBtn{position:fixed;left:16px;bottom:16px;border:none;border-radius:999px;padding:12px 16px;box-shadow:var(--shadow);background:var(--accent);color:#1e1e1e;cursor:pointer}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="brand">
        <div class="logo" aria-hidden="true">由</div>
        <div class="title">由闻之境 · Minimal</div>
      </div>
      <div class="hero">
        <h1>一句话介绍：记录探索与创造的足迹。</h1>
        <p>瀑布流卡片 · 标签筛选 · 弹窗阅读（文字/图片/视频）。支持本地保存与服务端保存。</p>
      </div>
      <nav class="filters" aria-label="筛选标签"></nav>
    </div>
  </header>

  <main>
    <section class="masonry" id="masonry" aria-live="polite"></section>
  </main>

  <button class="to-top" id="toTop" hidden>↑</button>
  <button id="addBtn" title="新增卡片">＋ 新增卡片</button>

  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="dlg-title">
    <div class="dialog">
      <button class="close" id="closeBtn" aria-label="关闭"></button>
      <header>
        <h2 class="h1" id="dlg-title"></h2>
        <div class="meta" id="dlg-meta"></div>
      </header>
      <article class="article" id="dlg-body"></article>
    </div>
  </div>

  <div class="modal" id="newModal" role="dialog" aria-modal="true" aria-labelledby="new-title">
    <div class="dialog">
      <button class="close" id="newClose" aria-label="关闭"></button>
      <header>
        <h2 class="h1" id="new-title">新增文章/卡片</h2>
        <div class="meta">填写必要字段后保存</div>
      </header>
      <form class="article" id="newForm">
        <label>标题 <input required name="title" placeholder="例如：我的第一篇文章" style="width:100%;padding:10px;border-radius:10px;border:1px solid color-mix(in oklab, var(--text) 12%, transparent)"></label>
        <label>日期 <input name="date" type="date" style="width:100%;padding:10px;border-radius:10px;border:1px solid color-mix(in oklab, var(--text) 12%, transparent)"></label>
        <label>标签（用逗号分隔） <input name="tags" placeholder="前端, 设计" style="width:100%;padding:10px;border-radius:10px;border:1px solid color-mix(in oklab, var(--text) 12%, transparent)"></label>
        <label>封面图 URL <input name="cover" placeholder="https://..." style="width:100%;padding:10px;border-radius:10px;border:1px solid color-mix(in oklab, var(--text) 12%, transparent)"></label>
        <label>摘要 <input name="summary" placeholder="一句话概述" style="width:100%;padding:10px;border-radius:10px;border:1px solid color-mix(in oklab, var(--text) 12%, transparent)"></label>
        <label>正文（每行一段）<textarea name="body" rows="6" placeholder="每行作为一段" style="width:100%;padding:10px;border-radius:10px;border:1px solid color-mix(in oklab, var(--text) 12%, transparent)"></textarea></label>
        <div style="display:flex;gap:12px;justify-content:flex-end">
          <button type="button" id="newCancel" class="chip">取消</button>
          <button type="submit" class="chip" style="background:var(--brand);border-color:var(--brand);color:#fff">保存</button>
        </div>
      </form>
    </div>
  </div>

<script>
// —— 示例默认内容 ——
const DEFAULT_POSTS = [
  { id:'demo1', title:'从 0 到 1：搭建个人站点的极简方法', date:'2025-08-14', tags:['建站','前端'],
    cover:'https://images.unsplash.com/photo-1504805572947-34fad45aed93?q=80&w=1200&auto=format&fit=crop',
    summary:'域名、托管、部署与内容组织的通用做法。',
    content:[{type:'p',text:'这是示例文章，真实数据保存在服务端（可选）或本地。'}] }
];

const filtersEl = document.querySelector('.filters');
const masonEl = document.getElementById('masonry');
const modal = document.getElementById('modal');
const dlgTitle = document.getElementById('dlg-title');
const dlgMeta = document.getElementById('dlg-meta');
const dlgBody = document.getElementById('dlg-body');
const closeBtn = document.getElementById('closeBtn');
const toTopBtn = document.getElementById('toTop');

// 新增弹窗相关
const addBtn = document.getElementById('addBtn');
const newModal = document.getElementById('newModal');
const newForm = document.getElementById('newForm');
const newClose = document.getElementById('newClose');
const newCancel = document.getElementById('newCancel');

// 状态
let activeTag = '全部';
let POSTS = [...DEFAULT_POSTS]; // 初始为默认，稍后尝试从服务端拉取

// —— 标签渲染 ——
function getAllTags(){
  const set = new Set(); POSTS.forEach(p => (p.tags||[]).forEach(t => set.add(t)));
  return ['全部', ...Array.from(set)];
}
function renderFilters(){
  filtersEl.innerHTML = '';
  getAllTags().forEach(tag =>{
    const b = document.createElement('button');
    b.className = 'chip'; b.type = 'button'; b.textContent = tag;
    b.setAttribute('aria-pressed', tag===activeTag);
    b.addEventListener('click', ()=>{ activeTag = tag; renderFilters(); renderCards(); window.scrollTo({top:0,behavior:'smooth'}); });
    filtersEl.appendChild(b);
  });
}

// —— 卡片渲染 ——
function renderCards(){
  const list = activeTag==='全部' ? POSTS : POSTS.filter(p => (p.tags||[]).includes(activeTag));
  masonEl.innerHTML = '';
  list.forEach(p =>{
    const card = document.createElement('article');
    card.className = 'card'; card.tabIndex = 0; card.setAttribute('role','button');
    card.setAttribute('aria-label',`打开文章：${p.title}`);
    card.innerHTML = `
      <img class="cover" src="${p.cover}" alt="${p.title} 封面" loading="lazy"/>
      <div class="content">
        <div>${(p.tags||[]).map(t=>`<span class='badge'>${t}</span>`).join('')}</div>
        <div class="title">${p.title}</div>
        <div class="meta" aria-hidden="true">${p.date} ${p.summary?`· ${p.summary}`:''}</div>
      </div>`;
    card.addEventListener('click', ()=> openModal(p));
    card.addEventListener('keypress', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); openModal(p); }});
    masonEl.appendChild(card);
  });
}

// —— 弹窗 ——
function openModal(post){
  dlgTitle.textContent = post.title;
  dlgMeta.textContent = `${post.date} · ${(post.tags||[]).join(' / ')}`;
  dlgBody.innerHTML = '';
  (post.content||[]).forEach(block =>{
    if(block.type==='p'){ const p = document.createElement('p'); p.textContent = block.text; dlgBody.appendChild(p); }
    else if(block.type==='img'){ const fig = document.createElement('figure'); fig.className='figure'; fig.innerHTML = `<img src="${block.src}" alt="${block.caption||post.title}" loading="lazy"/>${block.caption?`<figcaption>${block.caption}</figcaption>`:''}`; dlgBody.appendChild(fig); }
    else if(block.type==='video'){ const v = document.createElement('video'); v.controls=true; v.preload='none'; v.src = block.src; dlgBody.appendChild(v); }
  });
  modal.setAttribute('open',''); document.body.style.overflow='hidden';
}
function closeModal(){ modal.removeAttribute('open'); document.body.style.overflow=''; }
closeBtn.addEventListener('click', closeModal);
modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

// 回到顶部
window.addEventListener('scroll', ()=>{ const y = window.scrollY || document.documentElement.scrollTop; toTopBtn.hidden = y < 600; });
toTopBtn.addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));

// —— 新增弹窗 ——
function openNew(){ newModal.setAttribute('open',''); document.body.style.overflow='hidden'; }
function closeNew(){ newModal.removeAttribute('open'); document.body.style.overflow=''; newForm.reset(); }
addBtn.addEventListener('click', openNew);
newClose.addEventListener('click', closeNew);
newCancel.addEventListener('click', closeNew);
newModal.addEventListener('click', (e)=>{ if(e.target===newModal) closeNew(); });

newForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(newForm);
  const now = new Date();
  const post = {
    id: 'u_' + now.getTime(),
    title: (fd.get('title')||'').trim(),
    date: (fd.get('date')||now.toISOString().slice(0,10)),
    tags: (fd.get('tags')||'').split(',').map(s=>s.trim()).filter(Boolean),
    cover: (fd.get('cover')||'').trim() || 'https://picsum.photos/1200/800',
    summary: (fd.get('summary')||'').trim(),
    content: String(fd.get('body')||'').split('\n').map(t=>t.trim()).filter(Boolean).map(t=>({type:'p', text:t}))
  };
  // 先本地立即显示
  POSTS = [post, ...POSTS];
  renderFilters(); renderCards(); closeNew();
  // 同步到服务端（Vercel Functions）
  try{
    const resp = await fetch('/api/posts', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(post) });
    if(!resp.ok) throw new Error('HTTP '+resp.status);
  }catch(err){
    console.warn('服务端保存失败：', err);
    alert('已本地保存，但服务端保存失败。稍后重试或检查后端。');
  }
});

// —— 首次加载从服务端取（若失败，则使用默认） ——
(async function bootstrap(){
  try{
    const resp = await fetch('/api/posts');
    if(resp.ok){
      const data = await resp.json();
      if(Array.isArray(data) && data.length) POSTS = data;
    }
  }catch{ /* ignore */ }
  renderFilters(); renderCards();
})();
</script>
</body>
</html>
